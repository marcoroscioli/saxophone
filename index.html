<div class="instructions">
    <h3>How to Play:</h3>
    <p>🎵 Click the keys on the saxophone to play different notes</p>
    <p>🎹 Use your computer keyboard to play notes like a piano</p>
    <p>🔊 Adjust volume with the slider</p>
    <p>▶️ Click "Start Audio" first to enable sound</p>
    
    <div class="keyboard-hint">
        <strong>Keyboard Mapping (Piano-style):</strong><br>
        Row 1: Z S X D C V G B H N J M<br>
        Row 2: Q 2 W 3 E R 5 T 6 Y 7 U<br>
        Hold down **Shift** for Sustain Pedal!
        <span id="sustain-indicator" style="display:none; color: gold; margin-left: 10px;">(Sustain Active)</span>
    </div>
</div>

<script>
    let synth;
    let activeNotes = new Map();
    let audioStarted = false;
    let isSustaining = false;

    function initSynth() {
        const saxophoneSampler = new Tone.Sampler({
            urls: {
                "C4": "sax-c4.wav",
                "D#4": "sax-ds4.wav",
                "F#4": "sax-fs4.wav",
                "A4": "sax-a4.wav",
                "C5": "sax-c5.wav"
            },
            baseUrl: "https://tonejs.github.io/audio/saxophone/",
            onload: () => {
                console.log("Saxophone sampler loaded!");
            }
        }).toDestination();
        
        // Use a more realistic sampler sound instead of a basic synth
        synth = saxophoneSampler;
        
        // You can still add effects, but let's keep it simple for now
        // const reverb = new Tone.Reverb(2).toDestination();
        // synth.connect(reverb);
        
        // This volume control is now connected to the sampler
        document.querySelector('.volume-slider').addEventListener('input', (e) => {
            synth.volume.value = Tone.gainToDb(e.target.value / 100);
        });
    }

    async function startAudio() {
        if (!audioStarted) {
            await Tone.start();
            initSynth();
            audioStarted = true;
            document.querySelector('.control-btn').textContent = 'Audio Ready!';
            setTimeout(() => {
                document.querySelector('.control-btn').textContent = 'Start Audio';
            }, 2000);
        }
    }

    function playNote(note, keyElement) {
        if (!audioStarted) {
            alert('Please click "Start Audio" first!');
            return;
        }

        if (!activeNotes.has(note)) {
            // Use triggerAttackRelease for sampler
            synth.triggerAttackRelease(note, "8n");
            activeNotes.set(note, keyElement);
            
            if (keyElement) {
                keyElement.classList.add('active');
            }
        }
    }

    function stopNote(note) {
        if (activeNotes.has(note)) {
            const keyElement = activeNotes.get(note);
            if (!isSustaining) {
                // The Sampler's triggerAttackRelease handles the duration,
                // so we just need to remove the visual cue here.
                if (keyElement) {
                    keyElement.classList.remove('active');
                }
                activeNotes.delete(note);
            }
        }
    }

    function stopAllNotes() {
        // This is a bit more complex with a Sampler
        // We'll just clear the visual and internal state
        activeNotes.clear();
        document.querySelectorAll('.key').forEach(key => {
            key.classList.remove('active');
        });
    }

    // New Keyboard mapping for a more piano-like feel
    const keyMap = {
        'z': 'C4', 's': 'C#4', 'x': 'D4', 'd': 'D#4', 'c': 'E4', 'v': 'F4',
        'g': 'F#4', 'b': 'G4', 'h': 'G#4', 'n': 'A4', 'j': 'A#4', 'm': 'B4',
        'q': 'C5', '2': 'C#5', 'w': 'D5', '3': 'D#5', 'e': 'E5', 'r': 'F5',
        '5': 'F#5', 't': 'G5', '6': 'G#5', 'y': 'A5', '7': 'A#5', 'u': 'B5'
    };

    document.addEventListener('keydown', (e) => {
        const note = keyMap[e.key.toLowerCase()];
        if (e.key === 'Shift') {
            isSustaining = true;
            document.getElementById('sustain-indicator').style.display = 'inline';
        }
        if (note && !e.repeat) {
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            playNote(note, keyElement);
        }
    });

    document.addEventListener('keyup', (e) => {
        const note = keyMap[e.key.toLowerCase()];
        if (e.key === 'Shift') {
            isSustaining = false;
            document.getElementById('sustain-indicator').style.display = 'none';
            // Stop any notes that were being held by sustain
            activeNotes.forEach((keyElement, note) => {
                if (keyElement) {
                    keyElement.classList.remove('active');
                }
            });
            activeNotes.clear();
        }
        if (note) {
            stopNote(note);
        }
    });

    document.querySelectorAll('.key').forEach(key => {
        const note = key.dataset.note;
        
        // Mouse/touch events
        key.addEventListener('mousedown', () => playNote(note, key));
        key.addEventListener('mouseup', () => stopNote(note));
        key.addEventListener('mouseleave', () => stopNote(note));
        key.addEventListener('touchstart', (e) => { e.preventDefault(); playNote(note, key); });
        key.addEventListener('touchend', (e) => { e.preventDefault(); stopNote(note); });
        key.addEventListener('contextmenu', e => e.preventDefault());
    });
</script>
